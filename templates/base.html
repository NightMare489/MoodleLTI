<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CodeJudge{% endblock %} | AAST Online Judge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <!-- Apply saved theme before paint to avoid flash -->
    <script>
        (function () {
            var t = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', t);
        })();
    </script>
    {% block head %}{% endblock %}
</head>

<body>
    {# locked_single = single-problem lock (hide nav). sheet = multi-problem (show nav). #}
    {% set pid_list = session.get('locked_problem_ids') %}
    {% set locked_single = pid_list|length == 1 if pid_list else false %}
    {% set is_instructor = session.get('role') == 'instructor' %}
    <nav class="navbar" {% if locked_single and not is_instructor %} style="justify-content:center" {% endif %}>
        <div class="nav-container">
            {% if not (locked_single and not is_instructor) %}
            <a href="{% if is_instructor %}{{ url_for('admin.dashboard') }}{% else %}{{ url_for('student.problem_list') }}{% endif %}"
                class="nav-brand">
                <span class="brand-icon">‚ö°</span>
                <span class="brand-text">CodeJudge</span>
            </a>
            {% endif %}
            <div class="nav-links">
                {% if not (locked_single and not is_instructor) %}
                {% if is_instructor %}
                <a href="{{ url_for('admin.dashboard') }}" class="nav-link">Dashboard</a>
                <a href="{{ url_for('admin.new_problem') }}" class="nav-link">+ New Problem</a>
                {% else %}
                <a href="{{ url_for('student.problem_list') }}" class="nav-link">Problems</a>
                <a href="{{ url_for('student.my_submissions') }}" class="nav-link">My Submissions</a>
                {% endif %}
                {% endif %}
                {% if session.get('user_name') %}
                <span class="nav-user">
                    <span class="user-avatar">{{ session.user_name[0] | upper }}</span>
                    {{ session.user_name }}
                    <span class="role-badge role-{{ session.role }}">{{ session.role }}</span>
                </span>
                {% endif %}
                <button class="theme-toggle" id="themeToggle" title="Toggle theme">üåô</button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
            <div class="flash flash-{{ category }}">
                {{ message }}
                <button class="flash-close" onclick="this.parentElement.remove()">√ó</button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <div class="footer-content">
            <span>AAST CodeJudge</span>
            <span class="footer-sep">¬∑</span>
            <span>Powered by LTI</span>
        </div>
    </footer>

    {% block scripts %}{% endblock %}

    <!-- KaTeX auto-render: $...$ for inline, $$...$$ for display -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            throwOnError: false
        });"></script>

    <!-- Theme toggle -->
    <script>
        (function () {
            var btn = document.getElementById('themeToggle');
            function updateIcon() {
                var current = document.documentElement.getAttribute('data-theme');
                btn.textContent = current === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
            updateIcon();
            btn.addEventListener('click', function () {
                var current = document.documentElement.getAttribute('data-theme');
                var next = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
                updateIcon();
            });
        })();
    </script>
</body>

</html>