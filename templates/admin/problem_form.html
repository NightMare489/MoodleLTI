{% extends "base.html" %}
{% block title %}{{ 'Edit' if problem else 'New' }} Problem{% endblock %}
{% block head %}
<!-- Ace Editor CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/theme-one_dark.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/mode-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/mode-c_cpp.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>{{ '‚úèÔ∏è Edit Problem' if problem else '‚ûï New Problem' }}</h1>
    </div>

    <div class="form-layout">
        <!-- Problem Form -->
        <div class="card">
            <h3>Problem Details</h3>
            <form method="POST"
                action="{% if problem %}{{ url_for('admin.edit_problem', problem_id=problem.id) }}{% else %}{{ url_for('admin.new_problem') }}{% endif %}">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" class="form-input"
                        value="{{ problem.title if problem else '' }}" placeholder="e.g., Two Sum, Fibonacci Sequence"
                        required>
                </div>

                <div class="form-group">
                    <label for="description">Problem Description <span class="hint">(Markdown supported ‚Äî use
                            <code>![alt|50%](image:file.png)</code> for images)</span></label>
                    <textarea id="description" name="description" class="form-textarea" rows="12" placeholder="Write the problem statement here. You can use Markdown formatting.

Example:
## Problem
Given an array of integers, find two numbers that add up to a target.

## Input
- First line: n (number of elements) and target
- Second line: n space-separated integers

## Output
- Two indices (0-indexed) that add up to target

## Constraints
- 2 ‚â§ n ‚â§ 10^5
- -10^9 ‚â§ nums[i] ‚â§ 10^9" required>{{ problem.description if problem else '' }}</textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="time_limit_ms">Time Limit (ms)</label>
                        <input type="number" id="time_limit_ms" name="time_limit_ms" class="form-input"
                            value="{{ problem.time_limit_ms if problem else 2000 }}" min="100" max="10000">
                    </div>
                    <div class="form-group">
                        <label for="memory_limit_mb">Memory Limit (MB)</label>
                        <input type="number" id="memory_limit_mb" name="memory_limit_mb" class="form-input"
                            value="{{ problem.memory_limit_mb if problem else 256 }}" min="16" max="512">
                    </div>
                </div>

                {% if problem %}
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_active" {{ 'checked' if problem.is_active }}>
                        <span>Active (visible to students)</span>
                    </label>
                </div>
                {% endif %}

                <!-- Solution Code (hidden textarea, synced by JS) -->
                <input type="hidden" name="solution_code" id="solutionCodeInput"
                    value="{{ problem.solution_code if problem else '' }}">
                <input type="hidden" name="solution_language" id="solutionLangInput"
                    value="{{ problem.solution_language if problem else 'c' }}">

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        {{ 'Save Changes' if problem else 'Create Problem' }}
                    </button>
                    {% if problem %}
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
                    {% endif %}
                </div>
            </form>
        </div>

        {% if problem %}
        <!-- Solution Code Editor -->
        <div class="card">
            <h3>üß™ Solution Code <span class="hint">(used to generate test case outputs)</span></h3>
            <div class="form-group">
                <label for="solutionLangSelect">Language</label>
                <select id="solutionLangSelect" class="form-select" style="max-width:200px;">
                    {% for key, lang in languages.items() %}
                    <option value="{{ key }}" {{ 'selected' if problem.solution_language==key }}>{{ lang.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div id="solutionEditor" class="code-editor"
                style="height:250px; border:1px solid var(--border); border-radius:8px;">{{ problem.solution_code or ''
                }}</div>
            <p class="text-secondary" style="margin-top:0.5rem; font-size:0.8rem;">
                Save the problem after editing the solution code, then use "Generate Output" below.
            </p>
        </div>

        <!-- Problem Images -->
        <div class="card">
            <h3>üì∑ Problem Images</h3>

            {% if images %}
            <div class="test-cases-list" style="margin-bottom:1rem;">
                {% for img in images %}
                <div class="test-case-item" style="align-items:center;">
                    <div class="tc-header" style="flex-wrap:wrap; gap:0.5rem;">
                        <div style="display:flex; align-items:center; gap:0.75rem; flex:1; min-width:0;">
                            <img src="{{ url_for('static', filename='uploads/' ~ problem.id ~ '/' ~ img.filename) }}"
                                style="height:48px; width:48px; object-fit:cover; border-radius:6px; border:1px solid var(--border);">
                            <code class="mono" style="font-size:0.8rem; word-break:break-all;">{{ img.filename }}</code>
                        </div>
                        <div style="display:flex; gap:0.4rem;">
                            <button type="button" class="btn btn-sm btn-secondary copy-img-ref"
                                data-ref="![image](image:{{ img.filename }})" title="Copy markdown reference">üìã
                                Copy</button>
                            <form method="POST"
                                action="{{ url_for('admin.delete_image', problem_id=problem.id, img_id=img.id) }}"
                                style="display:inline;" onsubmit="return confirm('Delete this image?')">
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-secondary">No images uploaded yet.</p>
            {% endif %}

            <form method="POST" action="{{ url_for('admin.upload_image', problem_id=problem.id) }}"
                enctype="multipart/form-data" style="display:flex; gap:0.5rem; align-items:end; flex-wrap:wrap;">
                <div class="form-group" style="flex:1; min-width:200px; margin:0;">
                    <input type="file" name="image" accept="image/*" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-secondary">üì§ Upload Image</button>
            </form>
            <p class="text-secondary" style="margin-top:0.5rem; font-size:0.8rem;">
                After uploading, copy the reference and paste it in the description.<br>
                Syntax: <code>![alt text](image:filename.png)</code> or
                <code>![alt text|50%](image:filename.png)</code> to resize.
            </p>
        </div>

        <!-- Test Cases -->
        <div class="card">
            <h3>Test Cases <span class="count-badge">{{ test_cases|length }}</span></h3>

            {% if test_cases %}
            <div class="test-cases-list">
                {% for tc in test_cases %}
                <div class="test-case-item">
                    <div class="tc-header">
                        <span class="tc-label">
                            Test Case #{{ loop.index }}
                            {% if tc.is_sample %}
                            <span class="sample-badge">Sample</span>
                            {% else %}
                            <span class="hidden-badge">Hidden</span>
                            {% endif %}
                        </span>
                        <form method="POST"
                            action="{{ url_for('admin.delete_test_case', problem_id=problem.id, tc_id=tc.id) }}"
                            style="display: inline;" onsubmit="return confirm('Delete this test case?')">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </div>
                    <div class="tc-content">
                        <div class="tc-io">
                            <div>
                                <label>Input:</label>
                                <pre class="io-block">{{ tc.input_data }}</pre>
                            </div>
                            <div>
                                <label>Expected Output:</label>
                                <pre class="io-block">{{ tc.expected_output }}</pre>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-secondary">No test cases yet. Add at least one below.</p>
            {% endif %}

            <hr class="divider">

            <h4>Add Test Case</h4>
            <form method="POST" action="{{ url_for('admin.add_test_case', problem_id=problem.id) }}"
                id="addTestCaseForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="input_data">Input</label>
                        <textarea id="input_data" name="input_data" class="form-textarea mono" rows="4"
                            placeholder="5 9&#10;2 7 11 15 1" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="expected_output">Expected Output</label>
                        <textarea id="expected_output" name="expected_output" class="form-textarea mono" rows="4"
                            placeholder="0 1" required></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_sample">
                        <span>Sample test case (visible to students)</span>
                    </label>
                </div>
                <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                    <button type="submit" class="btn btn-secondary">+ Add Test Case</button>
                    <button type="button" class="btn btn-primary" id="generateOutputBtn" {% if not problem.solution_code
                        %}disabled title="Save a solution code first" {% endif %}>
                        üîÑ Generate Output
                    </button>
                    <span id="generateStatus" class="text-secondary"
                        style="align-self:center; font-size:0.85rem;"></span>
                </div>
            </form>

            <hr class="divider">

            <h4>‚ö° Batch Generate Test Cases</h4>
            <p class="text-secondary" style="font-size:0.85rem; margin-bottom:0.75rem;">
                Paste multiple inputs separated by <strong>blank lines</strong>. Each block is treated as a separate
                test case. The solution code runs for each one and the output is auto-generated.
            </p>
            <div class="form-group">
                <label for="batch_inputs">Inputs (separated by blank lines)</label>
                <textarea id="batch_inputs" class="form-textarea mono" rows="8" placeholder="1

2

3

4

5"></textarea>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="batch_is_sample">
                    <span>Mark as sample test cases (visible to students)</span>
                </label>
            </div>
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
                <button type="button" class="btn btn-primary" id="batchGenerateBtn" {% if not problem.solution_code
                    %}disabled title="Save a solution code first" {% endif %}>
                    ‚ö° Batch Generate
                </button>
                <span id="batchStatus" class="text-secondary" style="font-size:0.85rem;"></span>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="card card-danger">
            <h3>‚ö†Ô∏è Danger Zone</h3>
            <p class="text-secondary">Deleting a problem removes all its test cases and submissions permanently.</p>
            <form method="POST" action="{{ url_for('admin.delete_problem', problem_id=problem.id) }}"
                onsubmit="return confirm('Are you sure? This will delete all test cases and submissions.')">
                <button type="submit" class="btn btn-danger">Delete Problem</button>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if problem %}
<script>
    // ‚îÄ‚îÄ Solution Code Editor (Ace) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const solEditor = ace.edit("solutionEditor");
    solEditor.setTheme("ace/theme/one_dark");
    solEditor.setFontSize(13);
    solEditor.setOptions({
        fontFamily: "'JetBrains Mono', monospace",
        showPrintMargin: false,
        wrap: true,
        tabSize: 4,
        useSoftTabs: true,
    });

    const modeMap = {
        'python': 'ace/mode/python',
        'c': 'ace/mode/c_cpp',
        'cpp': 'ace/mode/c_cpp',
    };

    const solLangSelect = document.getElementById('solutionLangSelect');
    solEditor.session.setMode(modeMap[solLangSelect.value] || 'ace/mode/c_cpp');
    solLangSelect.addEventListener('change', function () {
        solEditor.session.setMode(modeMap[this.value] || 'ace/mode/c_cpp');
    });

    // Sync solution editor ‚Üí hidden form fields before any form submit
    document.querySelectorAll('form').forEach(function (f) {
        f.addEventListener('submit', function () {
            document.getElementById('solutionCodeInput').value = solEditor.getValue();
            document.getElementById('solutionLangInput').value = solLangSelect.value;
        });
    });

    // ‚îÄ‚îÄ Generate Output Button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('generateOutputBtn').addEventListener('click', function () {
        const btn = this;
        const status = document.getElementById('generateStatus');
        const inputEl = document.getElementById('input_data');
        const outputEl = document.getElementById('expected_output');

        if (!inputEl.value.trim()) {
            status.textContent = '‚ö†Ô∏è Enter input first.';
            status.style.color = 'var(--yellow)';
            return;
        }

        btn.disabled = true;
        status.textContent = '‚è≥ Running solution...';
        status.style.color = 'var(--text-secondary)';

        fetch("{{ url_for('admin.generate_output', problem_id=problem.id) }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input_data: inputEl.value })
        })
            .then(r => r.json().then(data => ({ ok: r.ok, data })))
            .then(({ ok, data }) => {
                if (ok && data.output !== undefined) {
                    outputEl.value = data.output;
                    status.textContent = '‚úÖ Output generated!';
                    status.style.color = 'var(--green)';
                } else {
                    status.textContent = '‚ùå ' + (data.error || 'Unknown error');
                    status.style.color = 'var(--red)';
                }
            })
            .catch(err => {
                status.textContent = '‚ùå Network error';
                status.style.color = 'var(--red)';
            })
            .finally(() => { btn.disabled = false; });
    });

    // ‚îÄ‚îÄ Batch Generate Button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('batchGenerateBtn').addEventListener('click', function () {
        const btn = this;
        const status = document.getElementById('batchStatus');
        const inputEl = document.getElementById('batch_inputs');
        const isSample = document.getElementById('batch_is_sample').checked;

        if (!inputEl.value.trim()) {
            status.textContent = '‚ö†Ô∏è Enter at least one input.';
            status.style.color = 'var(--yellow)';
            return;
        }

        btn.disabled = true;
        status.textContent = '‚è≥ Running solution for all inputs...';
        status.style.color = 'var(--text-secondary)';

        fetch("{{ url_for('admin.generate_batch', problem_id=problem.id) }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ inputs_bulk: inputEl.value, is_sample: isSample })
        })
            .then(r => r.json().then(data => ({ ok: r.ok, data })))
            .then(({ ok, data }) => {
                if (ok && data.added !== undefined) {
                    let msg = `‚úÖ ${data.added} of ${data.total} test case(s) added!`;
                    if (data.errors && data.errors.length) {
                        msg += ` (${data.errors.length} failed)`;
                    }
                    status.textContent = msg;
                    status.style.color = 'var(--green)';
                    // Reload after a short delay so the user sees the message
                    setTimeout(() => location.reload(), 1200);
                } else {
                    status.textContent = '‚ùå ' + (data.error || 'Unknown error');
                    status.style.color = 'var(--red)';
                    btn.disabled = false;
                }
            })
            .catch(err => {
                status.textContent = '‚ùå Network error';
                status.style.color = 'var(--red)';
                btn.disabled = false;
            });
    });

    // ‚îÄ‚îÄ Copy image reference buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.querySelectorAll('.copy-img-ref').forEach(function (btn) {
        btn.addEventListener('click', function () {
            const ref = this.getAttribute('data-ref');
            navigator.clipboard.writeText(ref).then(() => {
                const orig = this.textContent;
                this.textContent = '‚úì Copied!';
                setTimeout(() => this.textContent = orig, 1500);
            });
        });
    });
</script>
{% endif %}
{% endblock %}